---
title: "Motor Vehicle Accidents in Victoria"
output: 
  flexdashboard::flex_dashboard:
        vertical_layout: scroll
        orientation: rows
        source_code: embed
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(janitor)
library(plotly)
library(ggResidpanel)
library(broom)
library(knitr)
library(kableExtra)
```

```{r load-data}
accidents <- read_csv("data/ACCIDENT.csv") %>%
  clean_names()

locations <- read_csv("data/ACCIDENT_LOCATION.csv") %>%
  clean_names()

nodes <- read_csv("data/NODE.csv") %>%
  clean_names()

persons <- read_csv("data/PERSON.csv") %>%
  clean_names()

vehicles <- read_csv("data/VEHICLE.csv") %>%
  clean_names()
```

```{r create-year-hour-day}
accidents <- accidents %>%
  mutate(accidentdate = dmy(accidentdate),
         Year = year(accidentdate),
         Hour = hour(accidenttime),
         Weekday = wday(accidentdate, 
                        label = TRUE,
                        abbr = FALSE))
```

Part 2 {data-icon="fa-battery-half"}
===================================== 

Row {.tabset data-height=500}
------------

### **Deaths by speed zone**

```{r accidents-by-speed-zone}
accidents_by_speed_zone <- accidents %>%
  count(speed_zone,
        name = "Accidents")
```

```{r deaths-by-speed-zone}
deaths_by_speed_zone <- accidents %>%
  group_by(speed_zone) %>%  
  tally(no_persons_killed,
        name = "Deaths")
```

```{r deaths-per-accident-by-speed-zone}
deaths_by_accident <- accidents_by_speed_zone %>%
  left_join(deaths_by_speed_zone) %>%
  mutate(Deaths_by_accident = Deaths/Accidents)
```

```{r deaths-per-accident-plot}
deaths_by_accident %>%
  mutate(speed_zone = as.numeric(speed_zone)) %>%
  filter(speed_zone %in% seq(30, 110, 10)) %>% 

  ggplot(aes(y = Deaths_by_accident, 
             x = speed_zone)) + 
  geom_line() +
  labs(x = "Speed Zone",
       y = "Deaths by Accident")

ggplotly()
```

Row {.tabset data-height=500}
------------
### **Death rate by year of vehicle manufacture**

```{r join-person-and-vehicle}
person_vehicle <- persons %>%
  left_join(vehicles)
```

```{r total-people-involved-in-accidents-per-manufature-year}
person_vehicle_total <- person_vehicle %>%
  group_by(vehicle_year_manuf) %>%
  tally(name = "Persons",
        sort = TRUE)

person_vehicle_deaths <- person_vehicle %>%
  filter(inj_level_desc == "Fatality") %>%
  group_by(vehicle_year_manuf) %>%
  tally(name = "Fatalities",
        sort = TRUE)
```

```{r join-total-and-deaths}
death_rate_by_year_manuf <- person_vehicle_total %>%
  left_join(person_vehicle_deaths) %>%
  mutate(death_rate = Fatalities/Persons) %>%
  arrange(desc(vehicle_year_manuf))
```
